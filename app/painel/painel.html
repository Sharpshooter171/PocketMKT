<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PocketMKT ‚Äì Painel (MVP WhatsApp)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f0f2f7; margin: 0; }
    .header { position: sticky; top: 0; z-index: 10; background:#2c3e50; color:#fff; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 10px rgba(0,0,0,.06) }
    .header h1 { margin:0; font-size:18px; font-weight:700 }
    .actions { display:flex; align-items:center; gap:10px }
    .badge { background:#27ae60; color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800 }
    /* Link estilo bot√£o para abrir em nova aba */
    #login-google {
      padding:8px 14px; background:#e67e22; color:#fff; border:0; border-radius:10px;
      font-weight:800; text-decoration:none; display:inline-flex; align-items:center; gap:6px;
    }
    .container { max-width:1280px; margin:0 auto; padding:18px }
    .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:18px }
    @media (max-width: 1000px){ .grid{ grid-template-columns: 1fr } }
    .card { background:#fff; border-radius:14px; box-shadow:0 10px 20px rgba(0,0,0,.06); padding:18px }
    .card h2 { margin:0 0 10px; font-size:18px; color:#1f2937; border-left:4px solid #3498db; padding-left:10px }
    .lead { color:#111827; font-size:14px; line-height:1.55 }
    .steps { margin-top:10px }
    .step { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:10px; font-size:14px; color:#1f2937 }
    .kbd { display:inline-block; padding:2px 6px; border:1px solid #cbd5e1; border-bottom-width:2px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; background:#f8fafc; color:#0f172a }
    .panel-section { margin-bottom:16px; background:#fff; border-radius:12px; border:1px solid #e5e7eb; }
    .panel-section > .head { padding:12px 14px; border-bottom:1px solid #e5e7eb; font-weight:800; color:#1f2937; background:#f9fafb; border-radius:12px 12px 0 0 }
    .panel-section .body { padding:12px 14px }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0 }
    .row label { font-size:13px; color:#111827; flex:1 }
    .row input[type="checkbox"]{ transform: scale(1.15); }
    .status-dot { width:10px; height:10px; border-radius:50% }
    .on { background:#10b981 }
    .off { background:#ef4444 }
    .btn { border:0; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer }
    .btn-primary { background:#6366f1; color:#fff }
    .btn-secondary { background:#0ea5e9; color:#fff }
    .btn-muted { background:#e5e7eb; color:#111827 }
    .debug-toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
    .debug-status { font-size:13px; margin-bottom:8px }
    .debug-console { height:420px; background:#0b1220; color:#e5e7eb; padding:12px; border-radius:12px; overflow-y:auto; font-family: ui-monospace, monospace; font-size:12px; border:1px solid #1f2937 }
    .debug-line { margin-bottom:6px; white-space: pre-wrap; word-break: break-word }
    .muted { color:#6b7280 }
  </style>
  <script>
    const BACKEND_BASE_URL = "{{ BACKEND_BASE_URL }}";
  </script>
</head>
<body>
  <div class="header">
    <h1>‚öñÔ∏è PocketMKT ‚Äì Painel (MVP WhatsApp)</h1>
    <div class="actions">
      <span class="badge">MODO MVP ‚Ä¢ WhatsApp + Twilio</span>
      <!-- Agora √© link abrindo em nova aba -->
      <a id="login-google" href="http://pocketmkt-api.duckdns.org/authorize" target="_blank" rel="noopener noreferrer">
        <span style="font-size:18px;">üîê</span> Conectar Google
      </a>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- ESQUERDA: Instru√ß√µes e Guia -->
      <div class="card">
        <h2>üìò Como testar o MVP (WhatsApp + Twilio)</h2>
        <p class="lead">Este painel n√£o simula mais chat. O fluxo oficial √© pelo WhatsApp (Twilio). Use as se√ß√µes √† direita para configurar e testar.</p>
        <div class="steps">
          <div class="step"><strong>1) Conectar Google</strong><br/>Clique em <span class="kbd">Conectar Google</span>. A autentica√ß√£o abrir√° em uma nova aba, mantendo o painel aberto.</div>
          <div class="step"><strong>2) Status</strong><br/>Em <span class="kbd">Debug</span>, use <em>Atualizar</em> para ver o estado do backend, Google e LLM.</div>
          <div class="step"><strong>3) WhatsApp</strong><br/>Envie uma sauda√ß√£o para o n√∫mero/sandbox do Twilio. Acompanhe os eventos no Debug.</div>
          <div class="step"><strong>4) Evid√™ncias</strong><br/>Use <em>Exportar Debug</em> para baixar um <code>.json</code> com todos os logs desta sess√£o.</div>
        </div>
        <div class="card" style="margin-top:12px;">
          <h2>üìö Guia de Testes do Assistente Modular</h2>
          <pre style="white-space: pre-wrap; font-size:13px; line-height:1.45; color:#111827;">{{ INSTRUCAO_TESTE_ASSISTENTE }}</pre>
        </div>
      </div>

      <!-- DIREITA: Toggles + Debug (Prompt Config REMOVIDO) -->
      <div>
        <!-- Fun√ß√µes do Advogado -->
        <div class="panel-section">
          <div class="head">üë®‚Äç‚öñÔ∏è Fun√ß√µes do Advogado</div>
          <div class="body" id="toggles-adv">
            <div class="row"><input type="checkbox" id="func_onboarding" checked><label for="func_onboarding">Onboarding Completo</label><div class="status-dot on" data-dot="func_onboarding"></div></div>
            <div class="row"><input type="checkbox" id="func_onboarding_completo" checked><label for="func_onboarding_completo">Onboarding + Planilha/Email</label><div class="status-dot on" data-dot="func_onboarding_completo"></div></div>
            <div class="row"><input type="checkbox" id="func_planilhas" checked><label for="func_planilhas">Cria√ß√£o de Planilhas</label><div class="status-dot on" data-dot="func_planilhas"></div></div>
            <div class="row"><input type="checkbox" id="func_email" checked><label for="func_email">Notifica√ß√µes Email</label><div class="status-dot on" data-dot="func_email"></div></div>
            <div class="row"><input type="checkbox" id="func_prazos" checked><label for="func_prazos">Verifica√ß√£o de Prazos</label><div class="status-dot on" data-dot="func_prazos"></div></div>
            <div class="row"><input type="checkbox" id="func_documentos" checked><label for="func_documentos">Gest√£o Documentos</label><div class="status-dot on" data-dot="func_documentos"></div></div>
            <div class="row"><input type="checkbox" id="func_honorarios" checked><label for="func_honorarios">Gest√£o Honor√°rios</label><div class="status-dot on" data-dot="func_honorarios"></div></div>
            <div class="row"><input type="checkbox" id="func_diario" checked><label for="func_diario">Consulta Di√°rio</label><div class="status-dot on" data-dot="func_diario"></div></div>
            <div class="row"><input type="checkbox" id="func_resumos" checked><label for="func_resumos">Resumos/Estat√≠sticas</label><div class="status-dot on" data-dot="func_resumos"></div></div>
            <div class="row"><input type="checkbox" id="func_relatorio_geral" checked><label for="func_relatorio_geral">Relat√≥rio Geral</label><div class="status-dot on" data-dot="func_relatorio_geral"></div></div>
            <div class="row"><input type="checkbox" id="func_relatorio_casos" checked><label for="func_relatorio_casos">Relat√≥rio Casos</label><div class="status-dot on" data-dot="func_relatorio_casos"></div></div>
            <div class="row"><input type="checkbox" id="func_relatorio_honorarios" checked><label for="func_relatorio_honorarios">Relat√≥rio Honor√°rios</label><div class="status-dot on" data-dot="func_relatorio_honorarios"></div></div>
            <div class="row"><input type="checkbox" id="func_resumo_pre_encontro" checked><label for="func_resumo_pre_encontro">Resumo Pr√©-Encontro</label><div class="status-dot on" data-dot="func_resumo_pre_encontro"></div></div>
            <div class="row"><input type="checkbox" id="func_preparar_audiencia" checked><label for="func_preparar_audiencia">Preparar Audi√™ncia</label><div class="status-dot on" data-dot="func_preparar_audiencia"></div></div>
            <div class="row"><input type="checkbox" id="func_enviar_resumo_email" checked><label for="func_enviar_resumo_email">Enviar Resumo por Email</label><div class="status-dot on" data-dot="func_enviar_resumo_email"></div></div>
            <div class="row"><input type="checkbox" id="func_verificar_notificacoes" checked><label for="func_verificar_notificacoes">Verificar Notifica√ß√µes</label><div class="status-dot on" data-dot="func_verificar_notificacoes"></div></div>
            <div class="row"><input type="checkbox" id="func_alterar_agendamento" checked><label for="func_alterar_agendamento">Alterar Agendamento</label><div class="status-dot on" data-dot="func_alterar_agendamento"></div></div>
            <div class="row"><input type="checkbox" id="func_cancelar_agendamento" checked><label for="func_cancelar_agendamento">Cancelar Agendamento</label><div class="status-dot on" data-dot="func_cancelar_agendamento"></div></div>
          </div>
        </div>

        <!-- Fun√ß√µes do Cliente -->
        <div class="panel-section">
          <div class="head">üë• Fun√ß√µes do Cliente</div>
          <div class="body" id="toggles-cli">
            <div class="row"><input type="checkbox" id="func_relato_casos" checked><label for="func_relato_casos">Relato de Casos</label><div class="status-dot on" data-dot="func_relato_casos"></div></div>
            <div class="row"><input type="checkbox" id="func_transcricao" checked><label for="func_transcricao">Transcri√ß√£o √Åudio</label><div class="status-dot on" data-dot="func_transcricao"></div></div>
            <div class="row"><input type="checkbox" id="func_agendamento" checked><label for="func_agendamento">Agendamento</label><div class="status-dot on" data-dot="func_agendamento"></div></div>
            <div class="row"><input type="checkbox" id="func_status" checked><label for="func_status">Status Conversa</label><div class="status-dot on" data-dot="func_status"></div></div>
            <div class="row"><input type="checkbox" id="func_extrair_infos" checked><label for="func_extrair_infos">Extra√ß√£o de Informa√ß√µes</label><div class="status-dot on" data-dot="func_extrair_infos"></div></div>
          </div>
        </div>

        <!-- Debug -->
        <div class="panel-section">
          <div class="head">üêû Debugging & Integra√ß√µes</div>
          <div class="body">
            <div class="debug-toolbar">
              <button class="btn btn-primary" id="btn-debug-refresh">üîÑ Atualizar</button>
              <button class="btn btn-secondary" id="btn-export">‚¨áÔ∏è Exportar Debug</button>
              <button class="btn btn-muted" id="btn-clear">üßπ Limpar</button>
              <label class="muted" style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="auto-poll" checked/> Auto (10s)</label>
            </div>
            <div class="debug-status">
              Backend: <span id="st-backend" class="muted">‚Äî</span> ‚Ä¢
              Google: <span id="st-google" class="muted">‚Äî</span> ‚Ä¢
              LLM: <span id="st-llm" class="muted">‚Äî</span>
            </div>
            <div id="debug-console" class="debug-console" role="log" aria-label="Console de debug"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Infos -->
    <div class="card" style="margin-top:12px;">
      <div style="display:flex;flex-wrap:wrap;gap:16px;font-size:13px;">
        <div>BACKEND_BASE_URL: <strong id="row-backend">‚Äî</strong></div>
        <div>Painel: <strong id="row-location">‚Äî</strong></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Debug Console =====
    const debugEl = document.getElementById('debug-console');
    const logs = [];
    function addLog(obj) {
      const entry = { t: new Date().toISOString(), ...obj };
      logs.push(entry);
      const line = document.createElement('div'); line.className = 'debug-line';
      line.textContent = JSON.stringify(entry);
      debugEl.appendChild(line); debugEl.scrollTop = debugEl.scrollHeight;
    }
    async function fetchStatus(){
      try{
        // Usar o proxy local do painel para evitar CORS
        const r = await fetch(`/status`, { credentials: 'omit' });
        const j = await r.json().catch(()=>({}));
        document.getElementById('st-backend').textContent = r.ok ? 'ONLINE' : `HTTP ${r.status}`;
        const googleOk = j.google_oauth === true || (j.backend_status && j.backend_status.google_oauth === true);
        document.getElementById('st-google').textContent = googleOk ? 'Autenticado' : 'Desconectado';
        const llm = (j.backend_status && j.backend_status.llm) || j.llm || 'desconhecido';
        document.getElementById('st-llm').textContent = typeof llm === 'string' ? llm : JSON.stringify(llm);
        addLog({ type:'status', ok:r.ok, body:j });
      }catch(e){
        document.getElementById('st-backend').textContent = 'OFFLINE';
        document.getElementById('st-google').textContent = '‚Äî';
        document.getElementById('st-llm').textContent = '‚Äî';
        addLog({ type:'status_error', error:String(e) });
      }
    }
    document.getElementById('btn-debug-refresh').addEventListener('click', fetchStatus);
    document.getElementById('btn-clear').addEventListener('click', ()=>{ logs.length=0; debugEl.innerHTML=''; addLog({type:'console_cleared'}) });
    document.getElementById('btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({ exported_at:new Date().toISOString(), logs }, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`pocketmkt-debug-${new Date().toISOString().replaceAll(':','-')}.json`; a.click(); URL.revokeObjectURL(url);
      addLog({ type:'export', count: logs.length });
    });
    const autoPoll = document.getElementById('auto-poll'); let poll=null;
    function startPoll(){ stopPoll(); poll=setInterval(fetchStatus, 10000) }
    function stopPoll(){ if(poll){ clearInterval(poll); poll=null } }
    autoPoll.addEventListener('change', ()=> autoPoll.checked ? startPoll() : stopPoll());
    const toggleIds = ['func_onboarding','func_onboarding_completo','func_planilhas','func_email','func_prazos','func_documentos','func_honorarios','func_diario','func_resumos','func_relatorio_geral','func_relatorio_casos','func_relatorio_honorarios','func_resumo_pre_encontro','func_preparar_audiencia','func_enviar_resumo_email','func_verificar_notificacoes','func_alterar_agendamento','func_cancelar_agendamento','func_relato_casos','func_transcricao','func_agendamento','func_status','func_extrair_infos'];
    function applyDot(id, on){ const dot=document.querySelector(`.status-dot[data-dot="${id}"]`); if(!dot) return; dot.classList.toggle('on', on); dot.classList.toggle('off', !on); }
    function loadToggles(){
      toggleIds.forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        const saved=localStorage.getItem('toggle.'+id);
        if(saved!==null){ el.checked = saved==='1' }
        applyDot(id, el.checked);
        el.addEventListener('change', ()=>{
          localStorage.setItem('toggle.'+id, el.checked ? '1':'0');
          applyDot(id, el.checked);
          addLog({ type:'toggle', id, enabled: el.checked });
        });
      });
    }
    document.getElementById('row-backend')?.textContent = BACKEND_BASE_URL || 'N/D';
    document.getElementById('row-location')?.textContent = window.location.href;
    loadToggles(); fetchStatus(); startPoll();
  </script>
</body>
</html>
