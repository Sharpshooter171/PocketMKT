<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PocketMKT - Painel (MVP WhatsApp)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0;
    }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: #2c3e50; color: white;
      padding: 16px 24px; z-index: 1000;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .header h1 { margin: 0; font-size: 20px; font-weight: 600; }
    .header .actions { display:flex; align-items:center; gap:12px; }
    .badge {
      background: #27ae60; color: white;
      padding: 6px 10px; border-radius: 16px; font-size: 12px; font-weight: 700;
    }
    .container {
      max-width: 1200px; margin: 0 auto;
      padding: 96px 18px 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 18px;
    }
    .card {
      background: white; border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      padding: 18px;
    }
    .card h2 {
      margin: 0 0 10px; font-size: 18px; color: #2c3e50; border-left: 4px solid #3498db; padding-left: 10px;
    }
    .lead {
      font-size: 14px; color: #2c3e50; line-height: 1.55;
    }
    .steps { margin-top: 10px; }
    .step {
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;
      padding: 12px; margin-bottom: 10px;
    }
    .step strong { color: #0f172a; }
    .kbd {
      display: inline-block; padding: 2px 6px; border: 1px solid #cbd5e1; border-bottom-width: 2px; border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px; background: #f8fafc; color:#0f172a;
    }

    /* Debug console grande */
    .debug-toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .btn {
      border: none; border-radius: 8px; padding: 8px 12px; font-weight: 700; cursor: pointer;
    }
    .btn-primary { background: #6366f1; color: white; }
    .btn-secondary { background: #0ea5e9; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-muted { background: #e5e7eb; color: #111827; }

    .debug-status { font-size: 13px; margin-bottom: 8px; }
    .debug-console {
      height: 420px; /* MAIOR */
      width: 100%;
      background: #0b1220; color: #e5e7eb;
      padding: 12px; border-radius: 10px; overflow-y: auto; font-family: ui-monospace, monospace; font-size: 12px;
      border: 1px solid #1f2937;
    }
    .debug-line { margin-bottom: 6px; white-space: pre-wrap; word-break: break-word; }
    .muted { color:#9ca3af; }

    /* Painel lateral menor */
    .side-card .row { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; font-size:13px; }
    .side-card .row span.value { font-weight:700; color:#111827; }

    /* Bot√£o Google */
    #login-google {
      padding: 8px 14px; background: #e67e22; color: white; border: none; border-radius: 8px;
      font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    }
    #login-google[disabled] { opacity: 0.7; cursor: default; }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>

  <!-- Backend base URL injetada pelo servidor do painel -->
  <script>
    const BACKEND_BASE_URL = "{{ BACKEND_BASE_URL }}";
  </script>
</head>
<body>
  <div class="header">
    <h1>‚öñÔ∏è PocketMKT ‚Äì Painel (MVP WhatsApp)</h1>
    <div class="actions">
      <span id="role-badge" class="badge">MODO MVP ‚Ä¢ WhatsApp + Twilio</span>
      <button id="login-google"><span style="font-size:18px;">üîê</span> Conectar Google</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Coluna principal: instru√ß√µes (entrou no lugar do antigo chat) -->
      <div class="card">
        <h2>üìò Como testar o MVP (WhatsApp + Twilio)</h2>
        <p class="lead">
          Este painel n√£o simula mais chat. O fluxo oficial √© pelo WhatsApp, via Twilio. Siga os passos abaixo para validar ponta‚Äëa‚Äëponta.
        </p>
        <div class="steps">
          <div class="step">
            <strong>1) Conecte seu Google (Sheets/Calendar/Gmail)</strong><br/>
            Use o bot√£o <span class="kbd">Conectar Google</span> no topo. Em alguns ambientes, ele pode redirecionar para seu dom√≠nio
            com autentica√ß√£o. Ap√≥s autenticar, volte a esta p√°gina.
          </div>
          <div class="step">
            <strong>2) Verifique o Backend</strong><br/>
            Clique em <span class="kbd">Atualizar Debug</span> no bloco de Debug √† direita. Voc√™ dever√° ver o status do
            <em>backend</em>, LLM e integra√ß√µes do Google.
          </div>
          <div class="step">
            <strong>3) Teste pelo WhatsApp (Twilio)</strong><br/>
            Envie uma mensagem inicial (sauda√ß√£o simples) para o n√∫mero/sandbox configurado no Twilio. O backend ir√°
            processar a conversa e registrar eventos que voc√™ pode acompanhar no Debug.
          </div>
          <div class="step">
            <strong>4) Coleta de evid√™ncias</strong><br/>
            Use <span class="kbd">Exportar Debug</span> para baixar um arquivo <code>.json</code> com todos os logs coletados
            nesta sess√£o de testes.
          </div>
          <div class="step">
            <strong>Dicas</strong><br/>
            ‚Ä¢ Sempre comece com uma sauda√ß√£o (ex.: ‚ÄúOl√°, tudo bem?‚Äù).<br/>
            ‚Ä¢ Para acelerar a triagem, inclua: nome completo, motivo do contato e prefer√™ncia de hor√°rio.<br/>
            ‚Ä¢ Erros intermitentes de autentica√ß√£o Google geralmente se resolvem refazendo o login e voltando ao painel.
          </div>
        </div>
      </div>

      <!-- Coluna lateral: Debug ampliado e pain√©is auxiliares -->
      <div class="card side-card">
        <h2>üêû Debugging & Integra√ß√µes</h2>
        <div class="debug-toolbar">
          <button class="btn btn-primary" id="btn-debug-refresh">üîÑ Atualizar Debug</button>
          <button class="btn btn-secondary" id="btn-export">‚¨áÔ∏è Exportar Debug</button>
          <button class="btn btn-muted" id="btn-clear">üßπ Limpar Console</button>
          <label class="muted"><input type="checkbox" id="auto-poll" checked /> Auto atualizar (a cada 10s)</label>
        </div>
        <div class="debug-status">
          Backend: <span id="debug-backend-status" class="muted">checando...</span> ‚Ä¢
          Google: <span id="debug-google" class="muted">‚Äî</span> ‚Ä¢
          LLM: <span id="debug-llm" class="muted">‚Äî</span>
        </div>
        <div id="debug-console" class="debug-console" aria-label="Console de debug" role="log"></div>
      </div>
    </div>

    <!-- Cart√£o menor com info t√©cnica -->
    <div class="card" style="margin-top:18px;">
      <h2>‚öôÔ∏è Configura√ß√µes R√°pidas</h2>
      <div class="row"><span>BACKEND_BASE_URL:</span> <span id="row-backend" class="value">‚Äî</span></div>
      <div class="row"><span>Painel Atual:</span> <span class="value" id="row-location">‚Äî</span></div>
    </div>
  </div>

  <script>
    // ====== Bot√£o Google ======
    (function initGoogleBtn() {
      const btn = document.getElementById('login-google');

      function setStateIdle() {
        btn.innerHTML = '<span style="font-size:18px;">üîê</span> Conectar Google';
        btn.disabled = false;
      }
      function setStateLoading() {
        btn.textContent = '‚è≥ Redirecionando...';
        btn.disabled = true;
      }

      btn.addEventListener('click', () => {
        setStateLoading();
        // Pedido: apontar para https://pocketmkt-panel.duckdns.org/painel
        // (seu Nginx/Backend deve redirecionar para o fluxo de OAuth quando necess√°rio)
        window.location.href = 'https://pocketmkt-panel.duckdns.org/painel';
      });

      setStateIdle();
    })();

    // ====== Debug Console ======
    const debugConsoleEl = document.getElementById('debug-console');
    const logs = []; // mem√≥ria da sess√£o (export√°vel)

    function addLog(obj) {
      const entry = {
        t: new Date().toISOString(),
        ...obj
      };
      logs.push(entry);
      const line = document.createElement('div');
      line.className = 'debug-line';
      line.textContent = JSON.stringify(entry, null, 0);
      debugConsoleEl.appendChild(line);
      debugConsoleEl.scrollTop = debugConsoleEl.scrollHeight;
    }

    async function fetchStatus() {
      try {
        const res = await fetch(`${BACKEND_BASE_URL}/status`, { credentials: 'omit' });
        const json = await res.json().catch(() => ({}));
        // Atualiza status sint√©tico
        const googleOk = json.google_oauth === true ||
                         (json.backend_status && json.backend_status.google_oauth === true);
        const llm = (json.backend_status && json.backend_status.llm) || json.llm || 'desconhecido';
        document.getElementById('debug-backend-status').textContent =
          res.ok ? 'ONLINE' : `ERRO HTTP ${res.status}`;
        document.getElementById('debug-google').textContent = googleOk ? 'Autenticado' : 'Desconectado';
        document.getElementById('debug-llm').textContent = typeof llm === 'string' ? llm : JSON.stringify(llm);

        addLog({ type: 'status', ok: res.ok, body: json });
      } catch (e) {
        document.getElementById('debug-backend-status').textContent = 'OFFLINE';
        document.getElementById('debug-google').textContent = '‚Äî';
        document.getElementById('debug-llm').textContent = '‚Äî';
        addLog({ type: 'status_error', error: String(e) });
      }
    }

    // Bot√µes debug
    document.getElementById('btn-debug-refresh').addEventListener('click', fetchStatus);
    document.getElementById('btn-clear').addEventListener('click', () => {
      logs.length = 0;
      debugConsoleEl.innerHTML = '';
      addLog({ type: 'console_cleared' });
    });
    document.getElementById('btn-export').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify({ exported_at: new Date().toISOString(), logs }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replaceAll(':','-');
      a.href = url;
      a.download = `pocketmkt-debug-${ts}.json`;
      a.click();
      URL.revokeObjectURL(url);
      addLog({ type: 'export', count: logs.length });
    });

    // Auto-poll status
    const autoPoll = document.getElementById('auto-poll');
    let pollTimer = null;
    function startPoll() {
      stopPoll();
      pollTimer = setInterval(fetchStatus, 10000);
    }
    function stopPoll() {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }
    autoPoll.addEventListener('change', () => {
      if (autoPoll.checked) startPoll(); else stopPoll();
    });

    // Infos r√°pidas
    document.getElementById('row-backend').textContent = BACKEND_BASE_URL || 'N/D';
    document.getElementById('row-location').textContent = window.location.href;

    // Primeira carga:
    fetchStatus();
    startPoll();
  </script>
</body>
</html>
